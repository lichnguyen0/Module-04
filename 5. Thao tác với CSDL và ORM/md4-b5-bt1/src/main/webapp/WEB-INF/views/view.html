<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nghe nh·∫°c</title>
    <style>
        .audio-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .file-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .btn-download {
            display: inline-block;
            padding: 8px 16px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .btn-download:hover {
            background: #218838;
        }
        .playlist-info {
            background: #d1ecf1;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .nav-buttons {
            margin: 15px 0;
        }
        .nav-buttons a {
            display: inline-block;
            padding: 8px 16px;
            margin-right: 10px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .nav-buttons a:hover {
            background: #0056b3;
        }
        .nav-buttons a.disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .keyboard-shortcuts {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .auto-play-toggle {
            background: #e7f3ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #b3d9ff;
        }
    </style>
</head>
<body>

<h2 th:text="${song.name}"></h2>

<!-- TH√îNG TIN PLAYLIST -->
<div class="playlist-info">
    <p>
        <strong>Playlist:</strong>
        B√†i <span th:text="${currentIndex}"></span> / <span th:text="${totalSongs}"></span>
        <span th:if="${nextSongId}"> | <strong>‚úÖ T·ª± ƒë·ªông ph√°t b√†i ti·∫øp theo</strong></span>
        <span th:unless="${nextSongId}"> | <strong>‚èπÔ∏è B√†i cu·ªëi c√πng</strong></span>
    </p>
</div>

<!-- TOGGLE AUTO PLAY -->
<div class="auto-play-toggle">
    <label>
        <input type="checkbox" id="autoPlayToggle" checked>
        <strong>T·ª± ƒë·ªông ph√°t b√†i ti·∫øp theo</strong>
    </label>
</div>

<div class="file-info">
    <p><strong>Ngh·ªá sƒ©:</strong> <span th:text="${song.artist}"></span></p>
    <p><strong>Th·ªÉ lo·∫°i:</strong> <span th:text="${song.genre}"></span></p>
    <p><strong>File:</strong> <span th:text="${song.filePath}"></span></p>
    <p><strong>ƒê·ªãnh d·∫°ng:</strong> <span th:text="${fileType}"></span></p>
</div>

<!-- NAVIGATION BUTTONS -->
<div class="nav-buttons">
    <a th:href="@{'/songs/prev/' + ${song.id}}">‚èÆÔ∏è B√†i tr∆∞·ªõc</a>
    <a th:if="${nextSongId}" th:href="@{'/songs/next/' + ${song.id}}">‚è≠Ô∏è B√†i ti·∫øp theo</a>
    <a th:unless="${nextSongId}" class="disabled">‚è≠Ô∏è B√†i ti·∫øp theo</a>
</div>

<div class="audio-container">
    <h3>NGHE NH·∫†C</h3>
    <!-- üÜï TH√äM autoplay attribute -->
    <audio id="audioPlayer" controls
           th:attr="autoplay=${autoplay} ? 'autoplay' : null"
           style="width: 100%; max-width: 600px;">
        <source th:src="@{'/uploads/' + ${song.filePath}}" th:type="${fileType}">
        <source th:src="@{'/uploads/' + ${song.filePath}}" type="audio/webm">
        <source th:src="@{'/uploads/' + ${song.filePath}}" type="audio/mpeg">
        <source th:src="@{'/uploads/' + ${song.filePath}}" type="audio/wav">
        <p>Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh d·∫°ng audio n√†y.
            <a th:href="@{'/uploads/' + ${song.filePath}}" download>T·∫£i file v·ªÅ</a>
        </p>
    </audio>

    <!-- DOWNLOAD LINK -->
    <p style="margin-top: 10px;">
        <a th:href="@{'/uploads/' + ${song.filePath}}" download class="btn-download">
            üì• T·∫£i file g·ªëc
        </a>
    </p>
</div>

<!-- TH√îNG B√ÅO PH√çM T·∫ÆT -->
<div class="keyboard-shortcuts">
    <small>
        <strong>üéπ Ph√≠m t·∫Øt:</strong>
        <kbd>Space</kbd> (Play/Pause) ‚Ä¢
        <kbd>‚Üê</kbd> (B√†i tr∆∞·ªõc) ‚Ä¢
        <kbd>‚Üí</kbd> (B√†i ti·∫øp theo) ‚Ä¢
        <kbd>R</kbd> (Replay) ‚Ä¢
        <kbd>A</kbd> (Toggle Auto-play)
    </small>
</div>

<!-- JAVASCRIPT AUTO PLAY NEXT -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const audioPlayer = document.getElementById('audioPlayer');
        const autoPlayToggle = document.getElementById('autoPlayToggle');
        const nextSongId = [[$,{nextSongId}]];

        // üÜï L·∫§Y TR·∫†NG TH√ÅI AUTO-PLAY T·ª™ LOCALSTORAGE
        const savedAutoPlay = localStorage.getItem('autoPlayEnabled');
        if (savedAutoPlay !== null) {
            autoPlayToggle.checked = savedAutoPlay === 'true';
        }

        // üÜï T·ª∞ ƒê·ªòNG PLAY KHI TRANG LOAD
        audioPlayer.play().catch(function(error) {
            console.log('Auto-play b·ªã ch·∫∑n:', error);
            // Hi·ªán th√¥ng b√°o y√™u c·∫ßu user t∆∞∆°ng t√°c
            showNotification('üîá Click v√†o player ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√°t nh·∫°c', 'warning');
        });

        // üÜï L∆ØU TR·∫†NG TH√ÅI AUTO-PLAY
        autoPlayToggle.addEventListener('change', function() {
            localStorage.setItem('autoPlayEnabled', this.checked);
            showNotification(this.checked ? '‚úÖ B·∫≠t auto-play' : '‚ùå T·∫Øt auto-play', 'info');
        });

        // T·ª∞ ƒê·ªòNG CHUY·ªÇN B√ÄI KHI K·∫æT TH√öC (CH·ªà KHI AUTO-PLAY B·∫¨T)
        audioPlayer.addEventListener('ended', function() {
            if (autoPlayToggle.checked && nextSongId) {
                console.log('B√†i h√°t k·∫øt th√∫c, chuy·ªÉn sang b√†i ti·∫øp theo...');

                // HI·ªÜN TH√îNG B√ÅO
                showNotification('üîÑ ƒêang chuy·ªÉn sang b√†i ti·∫øp theo...', 'info');

                // üÜï CHUY·ªÇN TRANG V√Ä GI·ªÆ AUTO-PLAY
                setTimeout(function() {
                    window.location.href = '/songs/next/' + [[$,{song:id}]];
                }, 1500);
            }
        });

        // PH√çM T·∫ÆT
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight' && nextSongId) {
                // Ph√≠m ‚Üí : Chuy·ªÉn b√†i ti·∫øp theo
                event.preventDefault();
                window.location.href = '/songs/next/' + [[$,{song:id}]];
            } else if (event.key === 'ArrowLeft') {
                // Ph√≠m ‚Üê : Chuy·ªÉn b√†i tr∆∞·ªõc
                event.preventDefault();
                window.location.href = '/songs/prev/' + [[$,{song:id}]];
            } else if (event.key === ' ') {
                // Ph√≠m Space: Play/Pause
                event.preventDefault();
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    showNotification('‚ñ∂Ô∏è ƒêang ph√°t', 'success');
                } else {
                    audioPlayer.pause();
                    showNotification('‚è∏Ô∏è T·∫°m d·ª´ng', 'warning');
                }
            } else if (event.key === 'r' || event.key === 'R') {
                // Ph√≠m R: Replay
                event.preventDefault();
                audioPlayer.currentTime = 0;
                audioPlayer.play();
                showNotification('üîÅ Ph√°t l·∫°i t·ª´ ƒë·∫ßu', 'info');
            } else if (event.key === 'a' || event.key === 'A') {
                // Ph√≠m A: Toggle auto-play
                event.preventDefault();
                autoPlayToggle.checked = !autoPlayToggle.checked;
                autoPlayToggle.dispatchEvent(new Event('change'));
            }
        });

        // üÜï X·ª¨ L√ù AUTOPLAY POLICY C·ª¶A BROWSER
        let userInteracted = false;

        document.addEventListener('click', function() {
            if (!userInteracted) {
                userInteracted = true;
                // Th·ª≠ play l·∫°i khi user t∆∞∆°ng t√°c
                if (audioPlayer.paused) {
                    audioPlayer.play().catch(console.error);
                }
            }
        });

        audioPlayer.addEventListener('play', function() {
            console.log('B√†i h√°t b·∫Øt ƒë·∫ßu ph√°t');
            showNotification('üéµ ƒêang ph√°t: ' + [[$,{song:name}]], 'success', 3000);
        });

        // H√ÄM HI·ªÜN TH√îNG B√ÅO
        function showNotification(message, type, duration = 3000) {
            // Ki·ªÉm tra xem ƒë√£ c√≥ notification ch∆∞a
            const existingNotification = document.querySelector('.custom-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            const notification = document.createElement('div');
            const bgColor = type === 'info' ? '#17a2b8' :
                type === 'success' ? '#28a745' :
                    type === 'warning' ? '#ffc107' : '#007bff';

            notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            font-weight: bold;
            max-width: 300px;
        `;
            notification.className = 'custom-notification';
            notification.innerHTML = message;
            document.body.appendChild(notification);

            // T·ª∞ ƒê·ªòNG X√ìA SAU duration
            setTimeout(function() {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, duration);
        }

        console.log('Auto-play next song enabled. Next song ID:', nextSongId);
        console.log('Auto-play toggle:', autoPlayToggle.checked);
    });


    // üÜï X·ª¨ L√ù AUTOPLAY T·ª™ URL PARAMETER
    const urlParams = new URLSearchParams(window.location.search);
    const autoPlayParam = urlParams.get('autoplay');

    if (autoPlayParam === 'true') {
        console.log('Auto-play from URL parameter');
        // ƒê·∫£m b·∫£o audio b·∫Øt ƒë·∫ßu ph√°t
        setTimeout(() => {
            audioPlayer.play().catch(error => {
                console.log('Auto-play b·ªã ch·∫∑n, c·∫ßn user interaction:', error);
                showNotification('üîá Click v√†o player ƒë·ªÉ ti·∫øp t·ª•c ph√°t nh·∫°c', 'warning');
            });
        }, 500);
    }
</script>

<br>
<a th:href="@{/songs}">‚Üê Quay l·∫°i danh s√°ch</a>

</body>
</html>